---
layout: post
title: "架构之美--Facebook平台架构 笔记"
description: "Facebook 数据平台 架构"
category: 读书
tags: [Facebook 数据平台 架构]
---
{% include JB/setup %}
 <link href="http://kevinburke.bitbucket.org/markdowncss/markdown.css" rel="stylesheet"></link>

> 给我看你的流程图而藏起你的表，我将仍然莫名其妙。如果给我看你的表，那么我将不再需要你的流程图，因为它们太明显了。
>    ————Fred Brooks, 《The Mythical Man-Month》

<!--break-->

## 简介
+ 信息架构师坚信，处于大多数系统核心的是数据，而不是算法。
+ 在任何情况下，Web呈现的几乎所有面对用户的功能归根到底都是提供一个界面，访问站点专有的一组核心数据。这些信息构成了几乎所有网站的核心价值。（"n层"软件栈）。
+ Facebook是围绕数据建立架构的。Facebook的架构师关注的是显示和操作这些社会关系数据。对于用户来说，这个站点的价值直接来自于他和与他有关的人对该系统所贡献的数据的价值。
+ Facebook平台改变了数据访问系统的形态，它包含的愿景远远超出了n层栈的分离功能，目标是以应用的形式来集成外部的系统。利用居于架构中心的用户社会关系数据，该平台开发了一组Web服务(Facebook API)、一门查询语言(FQL)、以及一种数据驱动的标记语言(FBML)，目的是将应用开发者的系统与Facebook的系统结合在一起。
+ 受控的方式开放数据，调和数据开发与渗透在社会关系系统中独特的隐私需求的过程。
    + 促进这些类型的集成；
    + 将数据功能从内部栈调用移到外部可见的Web服务上(Facebook API);
    + 授权访问这个Web服务，注意保持这个社会关系系统的隐私性；
    + 创建一种数据查询语言，减轻这个Web服务的新客户端的负担(FQL);
    + 创建一种数据驱动的标记语言，将应用的显示集成回Facebook，同时也支持使用其他方式不能访问的数据(Facebook FBML);
    + 创建一些技术来弥补Facebook体验与外部应用体验之间的差异。


### 某些应用核心数据
+ 应用自身的一些数据

### Facebook核心数据
+ 社会关系数据

### Facebook的应用平台
在社会关系网络和数据架构方面的一些改进，实现了
+ 应用可以通过Facebook平台的数据服务来访问有用的社会关系数据，为外部的Web应用、桌面操作系统应用和其他设备上的应用提供社会关系上下文。
+ 应用可以通过一种名为FBML的数据驱动标记语言来实现显示，在http://facebook.com的页面上集成他们的应用体验。
+ 通过FBML所要求的架构改变，开发者可以使用Facebook平台的cookie和Facebook JavaScript(FBJS),从而让应用出现在http://facebook.com上所需的改动最小。
+ 最后，应用可以获得这些功能，同时不必牺牲隐私，也不必放弃对于Facebook为用户数据和显示提供的用户体验的期望。

***大多数的架构考虑是为了创建统一可用的社会关系上下文，它体现了这样的阴阳关系：数据可获得性和用户隐私。***

## 创建一个社会关系Web服务
### 实际问题
+ 应用可以利用在Facebook上的用户社会关系数据，但这种数据是不可访问的。

### 数据解决方案
+ 通过一个外部可以访问的Web服务来提供Facebook数据。
***Facebook的用户不认为他们的Facebook数据全部是公有的，Facebook层面的隐私，是通过平台API中的主要认证方式来实现的，即用户会话。***
1. 数据：创建一个XML Web服务
2. 简单的Web服务认证握手

## 创建社会关系数据查询服务
### 实际问题
+ 从Facebook平台API获取数据要比获取内部数据的开销大很多。

### 数据解决方案
+ 类似内部数据采用的模式，实现外部数据访问模式：一种查询服务。
***FQL代表了基于Facebook内部数据的另一项结构改进，是标准黑盒Web服务的进步。***
#### 批量方法调用
+ 提升效率
+ 不足之处：每次调用必须与其他调用的结果无关。如使用一次调用的结果作为下次调用的输入，则不能处理。

#### FQL
+ 简单的查询语言，保证了Facebook的内部数据。

## 创建一个社会关系Web门户：FBML
### 实际问题1
长期存在的问题：难以让数据、产品或系统得到广泛使用。***缺少用户。*** 而Facebook支持大量的用户，对在社会联系之间共享信息感兴趣，而且Facebook的特点就是把应用的内容和它自己的内容等同视之。

### 实际问题2
外部应用不能够使用Facebook没有通过Web服务暴露出来的那些核心数据元素。开发者如何才能利用这些数据？

### 数据解决方案
+ 思路：结合Facebook的数据和外部应用的数据、逻辑和显示，同时让用户在一个受信任的环境下操作。
+ 方案：开发者通过一种数据驱动的标记语言，在社会关系站点上创建应用执行和显示的内容，与Facebook交互。

`资产和约束`

     一方面: 具有一个访问频率很高的社会关系系统，让用户发现外部的内容，并有大量的社会关系数据来增强这种社会关系应用。
    另一方面: 请求需要从社会关系站点上发起，将应用作为服务来使用，然后将内容渲染成HTML、JavaScript和CSS，并且不违反Facebook用户的隐私和期望。

#### 不正确的尝试：Facebook上的应用直接渲染HTML、CSS和JS
+ 违反用户对facebook上受控体验的期望，让站点和用户暴露在各种安全攻击之下。***允许外部用户直接定制标记语言好脚本几乎从来都不是好主意，实际上，代码或脚本注入通常是攻击者的目标***
+ 没有新数据(没有达到要求)

#### 不正确的尝试：Facebook上的应用iframe
让浏览器作为代理者，而不是由Facebook作为请求代理者
+ 解决了安全，但开发者仍然不能利用其它的新数据

#### FBML是数据驱动的执行标记语言
特定的标记语言，其中定义了足够的标记来表现应用的逻辑和显示，也包含对受保护数据的请求，完全让Facebook在受信任的服务器环境中渲染它。

+ 修改已知的标准，将执行和决定延迟到Facebook平台服务器上进行。
+ FBML解释器让开发者通过FBML数据，自己能够控制在Facebook服务器上执行的逻辑和显示。这是数据处于执行中心的绝妙例子：FBML只是声明式的执行，而不是必须服从的控制流。
+ 标签
    + 直接的HTML标签
    + 数据显示标签
    + 数据执行标签
    + 只面向设计的标签
    + 替代HTML标签
    + “功能包”标签

#### FBML架构
+ 将输入字符串解析成一颗句法树，将这棵树中的标签转换成内部方法调用，应用FBML语法规则，保持容器站点的约束。

## 系统的支持功能
### 平台Cookie
+ 注意cookie的作用域，让Facebook具有浏览器的职责
### 平台FBJS
+ 重写FBML属性，确保实现虚拟文档范围
+ 延迟激活脚本内容，直到用户在页面或元素上发起动作时
+ 提供一些Facebook库，以受控的方式来实现常见的脚本使用场景

## 个人总结
1. 架构是递进的，随着Facebook走向平台，考虑的内容就不一样了，既要开放数据，又要控制数据；既要让应用使用隐私数据，又不能让他们获得；既需要应用的灵活性，又要保证隐私性、安全性和平台一致性，在这样的不断演化中，最终是在Facebook中提供了应用的执行环境；
2. 每一次的问题提炼很重要，在问题域确定的基础上才能真正解决好问题；
3. 有些问题是相互背离，这里需要权衡；有些问题是互相依赖，多个问题一起产生新问题，这里需要分析的全面性。


