---
layout: post
title: "架构之美---GNU Emacs架构 笔记"
description: "emacs 架构 isp"
category:   读书
tags: [emacs eclipse firefox 插件 架构]
---
{% include JB/setup %}

Emacs是用Emacs自己的编程语言Emacs Lisp编写的。Emacs Lisp并不支持对象，它的模块系统就是一种命名规范，所有基本的文本编辑操作使用了隐晦的全局变量，甚至局部变量也不是很局部。

功能集不断地成长；用户界面中不断增加了许多令人着迷新行为；而且整个项目有效避免了对基础架构的大幅修改、频繁的交互、领导者的冲突和分歧。其活力的源泉是什么？它有什么局限性？

其它软件可以从Emacs中学到什么？如果有一个新架构需要实现与Emacs相同的目标，在度量是否成功时应问什么问题？

<!--break-->

## 使用中的Emacs

Emacs的设计预想是你需要时只启动一次，然后一直运行着。

三种最基本的对象：

+ 帧：Emacs对计算机图形界面中窗口的称呼。
+ 窗口：帧的一部分。只有当前选中的窗口，才会对键盘命令进行响应。窗口是轻量级的，在使用时经常会频繁地创建和关闭。
+ 缓冲区：用来保存可编辑的文本内容。缓冲区的内容并不一定必须和某个文件关联：可能包括搜索结果、在线文档，以及刚输入还没有保存到任何文件的内容。

保存在缓冲区的内容都有响应的名称，这样做可以使得这些不同的内容都被当作可编辑的文本内容来处理：可以使用相同的命令在这些内容中导航、搜索、组织、剪裁、排序，就像文本缓冲区的其他内容那样。

***第一个问题***

>如何方便地将一个命令的输出结果作为另一个命令的输入？用户界面提供的命令能否相互组合？或者在命令运行结束之前，中间结果能否显示？

喜欢Unix命令行环境的一个主要原因在于这些命令能够有效地作为一部分整合到复杂的脚本中，虽然这些环境存在一些无理由的不一致、数据模型过于简单以及其他一些缺点。由于写一个能够脚本化的程序是十分简单的，因此很少走入死胡同。Emacs实现了相同的目标，尽管是以完全不同的方式实现的。

## Emacs的架构
Emacs架构所采用的是在交互式应用程序中应用广泛的MVC模式。
在Emacs中，控制器基本上是完全用Emacs Lisp语言编写的。Lisp最初是用来操作缓冲区中的内容(模型)以及窗口布局的。

### 模型：缓冲区
Emacs是用来编辑文本文件的，因此Emacs的模型中最为核心的是用来保存文本信息的缓冲区。

每一个缓冲区都有一种模式(mode),它用来指定针对特定类型文本进行编辑时的缓冲区行为。在Lisp等级，模式将使用缓冲区局部键绑定来为用户提供特定于某种模式的命令，然后使用缓冲区的局部变量来维护缓冲区状态。通过它们的组合，这些功能使缓冲区的模式与对象的类十分类似：模式用来确定哪些命令是可以的，并根据这些命令所以来的Lisp实现来提供相应的变量。

对于每个缓冲区，基本的文本编辑功能维护了一个“撤销”日志，它为撤销某些操作保存了足够的信息。

Lisp代码可以创建一个标记(marker)对象，它将随着文本的移动而变化。各种基本操作既可以接受以整数表示的位置参数，也能够接受标记对象的方法表示的位置参数。

Lisp代码可以为缓冲区中的字符添加文本属性。每个文本属性都将有一个名称和一个值，它们的内容可以是任何Lisp对象。

覆盖图(overlay)用来表示缓冲区中某些文字的相邻区域。覆盖图的起点和终点包含覆盖的文本以及标记。覆盖图不被视为缓冲区文本的一部分：字符串是不能拥有覆盖图的，而且"撤销"日志也无法记录对覆盖图终点的修改。

### 视图：Emacs重绘引擎
当用户编辑文本信息时、在窗口上进行操作时，Emacs重绘引擎将确保显示信息做出相应的更新。Emacs重绘引擎有两个重要的特性：

+ Emacs将自动更新显示：Lisp代码无法指定如何对显示结果进行更新。通过解除Lisp代码管理显示结果的职责，Emacs显著地简化了编写正确扩展插件的任务。
+ Emacs仅当等待用户输入时更新显示：

通过更新显示，以自动、高效地体现编辑操作的效果，Emacs彻底地简化了Lisp创建者的工具。
> 有些系统借鉴了类似的行为模式，最有代表性的是JavaScript。

### 控制器：Emacs Lisp
Emacs的核心是用独立的Lisp语言变体开发的。Emacs Lisp是Emacs能够成功地随着其发展提供大量功能的核心基础。

在Emacs中，命令就是程序员指定的复杂与用户交互的Emacs Lisp功能函数。命令的名称，就是Lisp功能函数的名称。keymaps用来绑定执行该命令按键序列、鼠标点击操作以及菜单项。核心Emacs代码将会在keymaps中查询与用户按键和鼠标操作相一致的定义，然后将控制前分发给相应的命令。

Emacs及其Lisp语言有几个关键的特性：

+ Emacs Lisp是轻量级的；
+ Emacs Lisp是交互式的；
+ 你自己写的Emacs Lisp程序将是一等公民；
+ Emacs Lisp是一种很完善的编程语言，很适合编写大型的程序；
+ Emacs Lisp是很安全的；
+ Emacs Lisp代码很容易生成文档；
+ Emacs Lisp不是一个模块化系统。取而代之的是通过内建的命名规范来实现在同一个Emacs会话中载入不相关的包时避免相互之间的干扰，因此用户可以相互共用Emacs Lisp代码包。

## 滋长的特性
Emacs不断滋长的特性是其架构的直接成因。一个典型的生命周期：

1. 进入门槛低，可以容易的实现想要的特性；
2. 定义了可以运行的命令后，只需要放置在自己的.emacs文件中就可以使其永久有效。如果经常使用，还可以绑定快捷键；
3. 成长之后，还可以封装成包分享；
4. 最后，一些流行的包将纳入Emacs发行版本中，使其标准功能得到扩展。

Emacs的发展都是一个民众主导的过程，充分反应了用户的兴趣：存在的功能，不管是显然需要还是很少使用的，都是因为有人编写了它、有人认为它很有用。

滋长的特性带来两方面的副作用：

1. 程序的用户界面将变得复杂、难以理解；
2. 程序本身变得难以维护。

Emacs成功处理第一个，不管第二个。更重视程序的功效。

### 滋长的特性和用户界面复杂性
评价用户界面复杂度的两个常见维度：

1. 要维护的模型的复杂度
2. 操作该模型的命令集的复杂度

#### 模型的复杂度
需要花多长时间来学习？模型对用户而言是隐藏的，或者比较晦涩，会影响其应用吗？

在所有的情况下，缓冲区的所有状态只关心其外观。这样的做法，其带来的结果之一就是使人容易知道Emacs对其文件内容做了什么修改。

#### 命令集的复杂度
发现相关的和有用的操作是否容易？
发现一个还未使用过的功能是否容易？

在此类复杂性上，Emacs用户界面具有命令行界面的很多共性：提供了大量可用的命令，用户并不需要全部操作它们，并且为用户发现新功能付出了很多努力。

### 滋长的特性和可维护性

Lisp语言扮演了重要的抽象边界的角色。Emacs Lisp代码和Lisp解释程序细节、底层处理器架构是高度隔离的。同样，Lisp所提供的文本编辑类基本操作隐藏了缓冲区、文本属性及其他编辑所需对象的底层操作细节；Lisp中的可见特性绝大部分都取决于开发人员长期的贡献与支持。

## 另外两个架构

### Eclipse
Eclipse的架构使开发人员能够将针对某个问题的有效解决方案集成到平台中，以得到一个统一的、功能齐备的开发环境。

如果Eclipse的架构不是处处预留端口，那么它将毫无价值，所有有效的功能都是由插件提供的。

Eclipse缺点：

+ Eclipse插件开发是不安全的。
+ 插件之间的接口相对复杂，编写插件更难；
+ 插件需要足够的样板文件代码，在Eclipse中提供了一个帮助大家编写插件的插件。

***第二个问题***

>值得考虑的就是关于插件机制的问题：在插件中可以使用哪类接口？它是否足够简单，只需要通过脚本化语言就能够完成快速开发？插件开发人员能否在较高抽象级别上开发，也就是更接近问题域？以及应用程序如何保护数据不被充满bug的代码破坏？

### Firefox

架构与Emacs的惊人相似之处：

+ 语义层面上的很多本质共性：如都是解释性的、高度动态的、安全的，都提供了垃圾回收机制。
+ 进入门槛低，也能解决大型问题。
+ 页面显示的管理也是自动的。
+ 将输入事件分发给JavaScript代码的过程是由浏览器管理的。

Firefix进一步应用了现代web应用程序背后的思想：Firefox自己的用户界面是使用相同的底层代码实现的，它们负责显示网页、处理对其的交互。

***第三个问题***
>该插件开发语言是否是为该应用程序添加新功能的最好方法？如果不是，那是什么原因导致了该限制？是语言本身的缺陷？是和模型层之间的接口过于麻烦？无论哪种情况，相同的缺点或许会以相同的形式影响插件开发人员，使插件成为二等公民。

与Emacs类似，Firefox将其插件开发语言视为架构的核心，最主要的观点是该语言和应用程序之间的关系应该正确的设计。

### ***Emacs架构课题的最大价值在于教会我们学会不要遗忘***

